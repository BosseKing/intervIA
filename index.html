<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Agent AI - Interview Automatique</title>
  <link rel="stylesheet" href="css/elegant_style.css">
</head>
<body>
  <!-- Navbar for theme choices -->
  <nav id="theme-navbar">
    <div class="theme-buttons">
      <div class="color-circle" style="background-color: #007bff;" onclick="setTheme('blue')" title="Bleu"></div>
      <div class="color-circle" style="background-color: #28a745;" onclick="setTheme('green')" title="Vert"></div>
      <div class="color-circle" style="background-color: #6f42c1;" onclick="setTheme('purple')" title="Violet"></div>
      <div class="color-circle" style="background-color: #dc3545;" onclick="setTheme('red')" title="Rouge"></div>
      <div class="color-circle" style="background-color: #fd7e14;" onclick="setTheme('orange')" title="Orange"></div>
      <div class="color-circle" style="background-color: #e83e8c;" onclick="setTheme('pink')" title="Rose"></div>
    </div>
    <div class="right-controls">
      <button id="theme-toggle-btn" onclick="toggleTheme()">‚òÄÔ∏è</button>
    </div>
  </nav>
  <!-- Interface candidat -->
  <div class="panel">
  
    <div id="chat"></div>
    <input id="userInput" type="text" placeholder="R√©ponds ici..." />
    <button id="sendBtn" onclick="sendAnswer()" disabled>Envoyer</button>
  </div>

  <!-- Interface recruteur -->
  <div class="panel" id="recruiterPanel">

    <p>√âvaluation de l'entretien :</p>
    <div id="feedback">En attente des r√©ponses du candidat...</div>
    <div id="finalResults" class="final-results" style="display: none;">
      <h3>R√©sultats finaux</h3>
      <div id="averageScore"></div>
      <div id="conclusion"></div>
    </div>
  </div>

  <script>
    const apiKey = "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";
    const model = "openai/gpt-3.5-turbo";
    const questions = [
      {
        text: "D√©crivez votre exp√©rience avec JavaScript en d√©tail, en mentionnant les frameworks que vous avez utilis√©s.",
        criteria: "Profondeur technique, pr√©cision des technologies mentionn√©es, pertinence pour le poste"
      },
      {
        text: "Donnez un exemple concret de projet en √©quipe o√π vous avez rencontr√© des difficult√©s. Comment les avez-vous r√©solues?",
        criteria: "Capacit√© √† travailler en √©quipe, r√©solution de probl√®mes, communication"
      },
      {
        text: "Comment g√©rez-vous les d√©lais serr√©s et les demandes changeantes? Donnez un exemple pr√©cis.",
        criteria: "Gestion du stress, adaptabilit√©, organisation"
      },
      {
        text: "Pourquoi pensez-vous √™tre le meilleur candidat pour ce poste? Soyez pr√©cis et argumentez.",
        criteria: "Pr√©paration √† l'entretien, connaissance de l'entreprise, arguments convaincants"
      }
    ];
    let currentQuestion = 0;
    let chat = document.getElementById("chat");
    let feedbackPanel = document.getElementById("feedback");
    let finalResultsPanel = document.getElementById("finalResults");
    let averageScorePanel = document.getElementById("averageScore");
    let conclusionPanel = document.getElementById("conclusion");
    let allFeedback = [];

    function sendMessage(text, sender) {
      const div = document.createElement("div");
      div.className = `message ${sender}`;
      div.innerHTML = `<strong>${sender === "ai" ? "Interviewer" : "Candidat"}:</strong> ${text}`;
      chat.appendChild(div);
      chat.scrollTop = chat.scrollHeight;
    }

    function sendAnswer() {
      const input = document.getElementById("userInput");
      const answer = input.value.trim();
      if (!answer) return;

      sendMessage(answer, "user");
      input.value = "";

      evaluateAnswer(questions[currentQuestion], answer);
      currentQuestion++;
      
      if (currentQuestion < questions.length) {
        setTimeout(() => {
          sendMessage(questions[currentQuestion].text, "ai");
        }, 1000);
      } else {
        setTimeout(() => {
          showFinalFeedback();
        }, 1500);
      }
    }

    async function evaluateAnswer(question, answer) {
      const prompt = `Tu es un intervieweur technique strict et exigeant. Tu dois √©valuer la r√©ponse du candidat de mani√®re rigoureuse mais  indulgente.
      
      Question: "${question.text}"
      Crit√®res d'√©valuation: ${question.criteria}
      R√©ponse du candidat: "${answer}"

      Analyse STRICTE selon ces r√®gles:
      1. Note sur 10 (0=mauvais, 10=excellent) - sois indulgent 
      2. Commentaire technique d√©taill√© pointant les lacunes
      3. Conseils pr√©cis pour am√©liorer la r√©ponse
      
      Format de r√©ponse EXCLUSIVEMENT en JSON VALIDE:
      {
        "note": nombre,
        "commentaire": "texte",
        "conseil": "texte"
      }`;

      try {
        const res = await fetch("https://openrouter.ai/api/v1/chat/completions", {
          method: "POST",
          headers: {
            "Authorization": `Bearer ${apiKey}`,
            "Content-Type": "application/json"
          },
          body: JSON.stringify({
            model: model,
            messages: [{ role: "user", content: prompt }],
            temperature: 0.3,
            response_format: { type: "json_object" }
          })
        });

        const data = await res.json();
        const content = data?.choices?.[0]?.message?.content;
        
        if (content) {
          const result = JSON.parse(content);
          if (typeof result.note !== 'number' || !result.commentaire || !result.conseil) {
            throw new Error("Format de r√©ponse invalide");
          }
          
          if (result.note > 7 && !answer.includes("exemple") && !answer.includes("concret")) {
            result.note = 6;
            result.commentaire += " [Note r√©duite - manque d'exemples concrets]";
          }
          
          allFeedback.push({ 
            question: question.text,
            criteria: question.criteria,
            ...result 
          });
          updateRecruiterPanel();
        }
      } catch (error) {
        console.error("Erreur d'√©valuation:", error);
        allFeedback.push({
          question: question.text,
          note: 0,
          commentaire: "Erreur d'√©valuation - r√©ponse non analysable",
          conseil: "Reprendre la r√©ponse avec plus de structure"
        });
        updateRecruiterPanel();
      }
    }

    function updateRecruiterPanel() {
      let html = "";
      allFeedback.forEach((fb, i) => {
        html += `‚ùì <strong>Question ${i + 1}:</strong> ${fb.question}\n`;
        html += `üìã <strong>Crit√®res:</strong> ${fb.criteria}\n`;
        html += `üìä <strong>Note:</strong> <span class="${fb.note < 5 ? 'strict' : ''}">${fb.note}/10</span>\n`;
        html += `üîç <strong>Analyse:</strong> ${fb.commentaire}\n`;
        html += `üí° <strong>Conseil:</strong> ${fb.conseil}\n\n`;
        html += "--------------------------------\n\n";
      });

      feedbackPanel.innerHTML = html;
    }

    function showFinalFeedback() {
      updateRecruiterPanel();
      
      // Calcul de la moyenne
      let total = 0;
      let validCount = 0;
      allFeedback.forEach(fb => {
        if (typeof fb.note === "number") {
          total += fb.note;
          validCount++;
        }
      });

      if (validCount > 0) {
        const avg = total / validCount;
        averageScorePanel.innerHTML = `üìà <strong>Moyenne g√©n√©rale:</strong> <span class="${avg < 5 ? 'strict' : ''}">${avg.toFixed(1)}/10</span>`;
        
        if (avg >= 8) {
          conclusionPanel.innerHTML = "‚úÖ <strong>Conclusion:</strong> Candidat exceptionnel - √Ä recruter imm√©diatement";
        } else if (avg >= 6) {
          conclusionPanel.innerHTML = "‚ö†Ô∏è <strong>Conclusion:</strong> Candidat acceptable - √Ä consid√©rer avec des r√©serves";
        } else {
          conclusionPanel.innerHTML = "‚ùå <strong>Conclusion:</strong> Candidat non retenu - Ne r√©pond pas aux exigences";
        }
      }

      // Afficher la section des r√©sultats finaux
      finalResultsPanel.style.display = "block";
      sendMessage("Entretien termin√©. Votre performance a √©t√© rigoureusement √©valu√©e. Consultez le panneau recruteur pour les d√©tails complets.", "ai");
    }

    // D√©marrer l'entretien
    window.onload = () => {
      // Load saved preferences
      const savedMode = localStorage.getItem('theme-mode');
      if (savedMode === 'dark') {
        document.body.classList.add('dark-mode');
        document.getElementById('theme-toggle-btn').innerHTML = 'üåô';
      } else {
        document.getElementById('theme-toggle-btn').innerHTML = '‚òÄÔ∏è';
      }

      const savedColor = localStorage.getItem('primary-color') || '#007bff';
      setPrimaryColor(savedColor);

      // Enable/disable send button based on input
      document.getElementById('userInput').addEventListener('input', function() {
        const btn = document.getElementById('sendBtn');
        btn.disabled = this.value.trim() === '';
      });

      sendMessage("Bonjour. Je vais vous poser une s√©rie de questions techniques. Soyez pr√©cis et concret dans vos r√©ponses. Des r√©ponses vagues ou incompl√®tes seront mal not√©es. Compris?", "ai");
      setTimeout(() => {
        sendMessage(questions[currentQuestion].text, "ai");
      }, 1500);
    };

    // Theme functions
    function setTheme(theme) {
      if (theme === 'blue') {
        setPrimaryColor('#007bff');
      } else if (theme === 'green') {
        setPrimaryColor('#28a745');
      } else if (theme === 'purple') {
        setPrimaryColor('#6f42c1');
      } else if (theme === 'red') {
        setPrimaryColor('#dc3545');
      } else if (theme === 'orange') {
        setPrimaryColor('#fd7e14');
      } else if (theme === 'pink') {
        setPrimaryColor('#e83e8c');
      }
    }

    function toggleTheme() {
      const body = document.body;
      const btn = document.getElementById('theme-toggle-btn');
      if (body.classList.contains('dark-mode')) {
        body.classList.remove('dark-mode');
        btn.innerHTML = '‚òÄÔ∏è';
        localStorage.setItem('theme-mode', 'light');
      } else {
        body.classList.add('dark-mode');
        btn.innerHTML = 'üåô';
        localStorage.setItem('theme-mode', 'dark');
      }
    }

    function setPrimaryColor(color) {
      document.documentElement.style.setProperty('--primary-color', color);
      const rgb = hexToRgb(color);
      document.documentElement.style.setProperty('--primary-rgb', rgb);
      localStorage.setItem('primary-color', color);
    }

    function hexToRgb(hex) {
      const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
      return result ? `${parseInt(result[1], 16)}, ${parseInt(result[2], 16)}, ${parseInt(result[3], 16)}` : null;
    }
  </script>
</body>
</html>
