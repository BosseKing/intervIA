<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Agent AI - Interview Automatique</title>
  <link rel="stylesheet" href="css/elegant_style.css">
  <!-- Dark mode toggle -->
  <div id="theme-toggle">
    <input type="checkbox" id="dark-mode-checkbox">
    <label for="dark-mode-checkbox" class="toggle-slider"></label>
    <label for="dark-mode-checkbox">Mode sombre</label>
  </div>
  <!-- Color customizer -->
  <div id="color-customizer">
    <label for="primary-color-input">Couleur principale:</label>
    <input type="color" id="primary-color-input" value="#007bff">
  </div>
</head>
<body>
  <!-- Interface candidat -->
  <div class="panel">
    <h2>Candidat</h2>
    <div id="chat"></div>
    <input id="userInput" type="text" placeholder="R√©ponds ici..." />
    <button onclick="sendAnswer()">Envoyer</button>
  </div>

  <!-- Interface recruteur -->
  <div class="panel" id="recruiterPanel">
    <h2>Recruteur</h2>
    <p>√âvaluation de l'entretien :</p>
    <div id="feedback">En attente des r√©ponses du candidat...</div>
    <div id="finalResults" class="final-results" style="display: none;">
      <h3>R√©sultats finaux</h3>
      <div id="averageScore"></div>
      <div id="conclusion"></div>
    </div>
  </div>

  <script>
    const apiKey = "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";
    const model = "openai/gpt-3.5-turbo";
    const questions = [
      {
        text: "D√©crivez votre exp√©rience avec JavaScript en d√©tail, en mentionnant les frameworks que vous avez utilis√©s.",
        criteria: "Profondeur technique, pr√©cision des technologies mentionn√©es, pertinence pour le poste"
      },
      {
        text: "Donnez un exemple concret de projet en √©quipe o√π vous avez rencontr√© des difficult√©s. Comment les avez-vous r√©solues?",
        criteria: "Capacit√© √† travailler en √©quipe, r√©solution de probl√®mes, communication"
      },
      {
        text: "Comment g√©rez-vous les d√©lais serr√©s et les demandes changeantes? Donnez un exemple pr√©cis.",
        criteria: "Gestion du stress, adaptabilit√©, organisation"
      },
      {
        text: "Pourquoi pensez-vous √™tre le meilleur candidat pour ce poste? Soyez pr√©cis et argumentez.",
        criteria: "Pr√©paration √† l'entretien, connaissance de l'entreprise, arguments convaincants"
      }
    ];
    let currentQuestion = 0;
    let chat = document.getElementById("chat");
    let feedbackPanel = document.getElementById("feedback");
    let finalResultsPanel = document.getElementById("finalResults");
    let averageScorePanel = document.getElementById("averageScore");
    let conclusionPanel = document.getElementById("conclusion");
    let allFeedback = [];

    function sendMessage(text, sender) {
      const div = document.createElement("div");
      div.className = `message ${sender}`;
      div.innerHTML = `<strong>${sender === "ai" ? "Interviewer" : "Candidat"}:</strong> ${text}`;
      chat.appendChild(div);
      chat.scrollTop = chat.scrollHeight;
    }

    function sendAnswer() {
      const input = document.getElementById("userInput");
      const answer = input.value.trim();
      if (!answer) return;

      sendMessage(answer, "user");
      input.value = "";

      evaluateAnswer(questions[currentQuestion], answer);
      currentQuestion++;
      
      if (currentQuestion < questions.length) {
        setTimeout(() => {
          sendMessage(questions[currentQuestion].text, "ai");
        }, 1000);
      } else {
        setTimeout(() => {
          showFinalFeedback();
        }, 1500);
      }
    }

    async function evaluateAnswer(question, answer) {
      const prompt = `Tu es un intervieweur technique strict et exigeant. Tu dois √©valuer la r√©ponse du candidat de mani√®re rigoureuse mais  indulgente.
      
      Question: "${question.text}"
      Crit√®res d'√©valuation: ${question.criteria}
      R√©ponse du candidat: "${answer}"

      Analyse STRICTE selon ces r√®gles:
      1. Note sur 10 (0=mauvais, 10=excellent) - sois indulgent 
      2. Commentaire technique d√©taill√© pointant les lacunes
      3. Conseils pr√©cis pour am√©liorer la r√©ponse
      
      Format de r√©ponse EXCLUSIVEMENT en JSON VALIDE:
      {
        "note": nombre,
        "commentaire": "texte",
        "conseil": "texte"
      }`;

      try {
        const res = await fetch("https://openrouter.ai/api/v1/chat/completions", {
          method: "POST",
          headers: {
            "Authorization": `Bearer ${apiKey}`,
            "Content-Type": "application/json"
          },
          body: JSON.stringify({
            model: model,
            messages: [{ role: "user", content: prompt }],
            temperature: 0.3,
            response_format: { type: "json_object" }
          })
        });

        const data = await res.json();
        const content = data?.choices?.[0]?.message?.content;
        
        if (content) {
          const result = JSON.parse(content);
          if (typeof result.note !== 'number' || !result.commentaire || !result.conseil) {
            throw new Error("Format de r√©ponse invalide");
          }
          
          if (result.note > 7 && !answer.includes("exemple") && !answer.includes("concret")) {
            result.note = 6;
            result.commentaire += " [Note r√©duite - manque d'exemples concrets]";
          }
          
          allFeedback.push({ 
            question: question.text,
            criteria: question.criteria,
            ...result 
          });
          updateRecruiterPanel();
        }
      } catch (error) {
        console.error("Erreur d'√©valuation:", error);
        allFeedback.push({
          question: question.text,
          note: 0,
          commentaire: "Erreur d'√©valuation - r√©ponse non analysable",
          conseil: "Reprendre la r√©ponse avec plus de structure"
        });
        updateRecruiterPanel();
      }
    }

    function updateRecruiterPanel() {
      let html = "";
      allFeedback.forEach((fb, i) => {
        html += `‚ùì <strong>Question ${i + 1}:</strong> ${fb.question}\n`;
        html += `üìã <strong>Crit√®res:</strong> ${fb.criteria}\n`;
        html += `üìä <strong>Note:</strong> <span class="${fb.note < 5 ? 'strict' : ''}">${fb.note}/10</span>\n`;
        html += `üîç <strong>Analyse:</strong> ${fb.commentaire}\n`;
        html += `üí° <strong>Conseil:</strong> ${fb.conseil}\n\n`;
        html += "--------------------------------\n\n";
      });

      feedbackPanel.innerHTML = html;
    }

    function showFinalFeedback() {
      updateRecruiterPanel();
      
      // Calcul de la moyenne
      let total = 0;
      let validCount = 0;
      allFeedback.forEach(fb => {
        if (typeof fb.note === "number") {
          total += fb.note;
          validCount++;
        }
      });

      if (validCount > 0) {
        const avg = total / validCount;
        averageScorePanel.innerHTML = `üìà <strong>Moyenne g√©n√©rale:</strong> <span class="${avg < 5 ? 'strict' : ''}">${avg.toFixed(1)}/10</span>`;
        
        if (avg >= 8) {
          conclusionPanel.innerHTML = "‚úÖ <strong>Conclusion:</strong> Candidat exceptionnel - √Ä recruter imm√©diatement";
        } else if (avg >= 6) {
          conclusionPanel.innerHTML = "‚ö†Ô∏è <strong>Conclusion:</strong> Candidat acceptable - √Ä consid√©rer avec des r√©serves";
        } else {
          conclusionPanel.innerHTML = "‚ùå <strong>Conclusion:</strong> Candidat non retenu - Ne r√©pond pas aux exigences";
        }
      }

      // Afficher la section des r√©sultats finaux
      finalResultsPanel.style.display = "block";
      sendMessage("Entretien termin√©. Votre performance a √©t√© rigoureusement √©valu√©e. Consultez le panneau recruteur pour les d√©tails complets.", "ai");
    }

    // D√©marrer l'entretien
    window.onload = () => {
      sendMessage("Bonjour. Je vais vous poser une s√©rie de questions techniques. Soyez pr√©cis et concret dans vos r√©ponses. Des r√©ponses vagues ou incompl√®tes seront mal not√©es. Compris?", "ai");
      setTimeout(() => {
        sendMessage(questions[currentQuestion].text, "ai");
      }, 1500);
    };

    // Dark mode toggle
    document.getElementById('dark-mode-checkbox').addEventListener('change', function() {
      document.body.classList.toggle('dark-mode');
    });

    // Color customization
    document.getElementById('primary-color-input').addEventListener('input', function() {
      document.documentElement.style.setProperty('--primary-color', this.value);
    });
  </script>
</body>
</html>
